require("dotenv").config();
const axios = require("axios");

const express = require("express");
const cors = require("cors");
const app = express();

const { TelegramClient } = require("telegram");
const { StringSession } = require("telegram/sessions");
const { NewMessage } = require("telegram/events/index.js");
const input = require("input");

const API_ID = +process.env.API_ID;
const API_HASH = process.env.API_HASH;
const SESSION = process.env.SESSION;

app.use(cors({ methods: ["GET", "POST"] }));
app.use(express.json());

async function startApp() {
  try {
    const stringSession = new StringSession(SESSION);
    const client = new TelegramClient(stringSession, API_ID, API_HASH, {
      connectionRetries: 5,
    });
    console.log("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!");

    await client.start();

    async function findChannel() {
      const dialogs = await client.getDialogs();

      const chat_slay = dialogs.find((chat) => chat.name === "Slay 5opka Chat");
      console.log(chat_slay);
    }

    //await findChannel();

    const commentGroupId = -1002398372400;

    //const commentGroupId = -1003299332773;

    client.addEventHandler(async (event) => {
      const message = event.message;

      if (Number(message.chatId.valueOf()) !== commentGroupId) return;

      if (message.fwdFrom && message.fwdFrom.channelPost) {
        console.log("üÜï –ù–æ–≤—ã–π –ø–æ—Å—Ç –∏–∑ –∫–∞–Ω–∞–ª–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω!");


        const photos = [
          'https://i.ibb.co/PvWMxRhF/5opka-1.jpg',
          'https://i.ibb.co/hr8tr8X/5opka-2.jpg',
          'https://i.ibb.co/1fLnBTsG/5opka-3.jpg',
          'https://i.ibb.co/4wvG8XSn/5opka-4.jpg',
          'https://i.ibb.co/x8sJzZN6/5opka-5.jpg'
        ]
        const comments = [
          "42 –±—Ä–∞—Ç—É—Ö–∏ –∑–∞ –Ω–∞—à–µ–≥–æ –±–æ—Å—Å–∞, —Ñ—É–≥–æ–±–æ—Ç—ã –ø—è—Ç–µ—Ä–∫–∞ –º–µ–≥–∞ —Ö–∞–π–ø –Ω–∞ SLAY!",
          "–ú–µ–º-–≥–æ–¥–∞, —Ö–∞–π–ø –≤—Å–µ–≥–æ Twitch, 5opka –∑–∞–±–∏—Ä–∞–µ—Ç Slay King 2025!",
          "–ü—è—Ç–µ—Ä–∫–∞ —Ä—É–ª–∏—Ç —Å—Ü–µ–Ω–æ–π, –º—ã —Ñ–∞–Ω–∞—Ç—ã, –∑–∞–ª—É–∂–µ–Ω–Ω–æ –≤—ã–∏–≥—Ä—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –≥–æ–¥!",
          "2023, 2024 –∏ 2025 ‚Äî –Ω–∞—à–∞ —ç—Ä–∞, –±–æ—Å—Å –≤—Å–µ–≥–æ Twitch –ø–æ–±–µ–∂–¥–∞–µ—Ç!",
          "–§—É–≥–æ–±–æ—Ç—ã –≤–∫–ª—é—á–µ–Ω—ã, –º–µ–≥–∞ —Ö–∞–π–ø, –º–µ–º-–≥–æ–¥–∞ –∏ –ø–æ–±–µ–¥–∞ –∑–∞ 5opka!",
          "–í—Å–µ –∑–∞ –æ–¥–Ω–æ–≥–æ, –æ–¥–∏–Ω –∑–∞ –≤—Å–µ—Ö, 42 –±—Ä–∞—Ç—É—Ö–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç –±–æ—Å—Å–∞!",
          "5opka –Ω–∞ —Ç—Ä–æ–Ω–µ Twitch, –º–µ–≥–∞ —Ö–∞–π–ø, –º–µ–º—ã, –ø–æ–±–µ–¥–∞ –∏ Slay King!",
          "–ü—è—Ç–µ—Ä–∫–∞ ‚Äî –±–æ—Å—Å –≤—Å–µ–≥–æ Twitch, –º—ã –∑–∞–±–∏—Ä–∞–µ–º –ø—Ä–µ–º–∏—é Slay 2025!",
          "–§—É–≥–æ–±–æ—Ç—ã –≥–æ—Ç–æ–≤—ã, —Ö–∞–π–ø –∑–∞—à–∫–∞–ª–∏–≤–∞–µ—Ç, –º–µ–º-–≥–æ–¥–∞ –∏ –ø–æ–±–µ–¥–∞ –Ω–∞ —Å—Ü–µ–Ω–µ!",
          "SLAY 2025, 5opka, –º–µ–≥–∞ —Ö–∞–π–ø, –º–µ–º-–≥–æ–¥–∞ –∏ —Ñ–∞–Ω–∞—Ç—ã –Ω–∞–≤—Å–µ–≥–¥–∞!",
        ];
        
        const randomPhoto = photos[Math.floor(Math.random() * photos.length)];
        const randomComment = comments[Math.floor(Math.random() * comments.length)];


        await client.sendMessage(commentGroupId, {
          file: randomPhoto,
          message: `<blockquote><b>${randomComment}</b></blockquote> \n #–±—Ä–∞—Ç—É—Ö–∞42 #–º–µ–≥–∞_—Ö–∞–π–ø #–ø–æ–±–µ–¥–∞_–Ω–µ_–∏–∑–±–µ–∂–Ω–∞`,
          parseMode: "html",
          replyTo: message.id,
        });

        console.log("‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:");
      }
    }, new NewMessage({ chats: [commentGroupId] }));
  } catch (err) {
    console.error("‚ùå –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞:", err);
    process.exit(1);
  }
}
startApp();

app.listen(3001, (err) => {
  err ? err : console.log("STARTED SERVER");
});
